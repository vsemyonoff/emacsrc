#!/usr/bin/env bash

# Homebrew install URL
BREW_INSTALL_URL="https://raw.githubusercontent.com/Homebrew/install/master/install"

# Common packages
COMM_PACKAGES=(
    hunspell
    python
    the_silver_searcher
)
# Arch packages
ARCH_PACKAGES=(
    "${COMM_PACKAGES[@]}"
    emacs
)
# Homebrew packages
BREW_PACKAGES=(
    "${COMM_PACKAGES[@]}"
    caskroom/cask/emacs
    gnu-tar
    terminal-notifier
)

# Detect OS
SYSTEM="$(uname -s)"

# Pretend run: just print all commands without execution
[[ ${1} == "-p" ]] && PRETEND="echo"

case "${SYSTEM}" in
    Darwin)
        [[ -z "$(which brew)" ]] && ${PRETEND} /usr/bin/ruby -e "$(curl -fsSL ${BREW_INSTALL_URL})"
        for i in ${!BREW_PACKAGES[@]}; do
            if [[ "${BREW_PACKAGES[i]}" =~ ^caskroom/.* ]]; then
                BREW="brew install --force"
            else
                BREW="brew reinstall"
            fi
            ${PRETEND} ${BREW} ${BREW_PACKAGES[i]}
        done
        ;;

    Linux)
        [[ -z "$(which pacman)" ]] && echo "'pacman' not instaled, exiting..." && exit 1
        [[ ${ARCH_PACKAGES} ]] && ${PRETEND} sudo pacman -Sy --needed --noconfirm ${ARCH_PACKAGES[@]}
        ;;
    *)
        echo "error: unsupported system ${SYSTEM}"
        ;;
esac

# Configure symlinks
EMACS_D="${HOME}/.emacs.d"
EMACS_D_SRC="$(cd $(dirname $(test -L ${0} && readlink ${0} || echo ${0}))/.. && pwd)"
if [[ "${EMACS_D_SRC}" != "${EMACS_D}" ]]; then
    if [[ -h "${EMACS_D}" ]]; then
        ${PRETEND} rm -f "${EMACS_D}"
    elif [[ -d "${EMACS_D}" ]]; then
        ${PRETEND} mv -v  "${EMACS_D}" "${EMACS_D}.save"
    fi
    ${PRETEND} ln -sv "${EMACS_D_SRC}" "${EMACS_D}"
fi

BIN_DIR="${HOME}/.bin"
[[ -h "${BIN_DIR}/emcl" ]] && ${PRETEND} rm -f "${BIN_DIR}/emcl"
${PRETEND} mkdir -p "${BIN_DIR}" && ${PRETEND} ln -sv "${EMACS_D}/bin/emcl" "${BIN_DIR}/emcl"

DATA_DIR="${XDG_DATA_HOME:-${HOME}/.local/share}"
[[ -h "${DATA_DIR}/emacs" ]] && ${PRETEND} rm -f "${DATA_DIR}/emacs"
${PRETEND} mkdir -p "${DATA_DIR}" && ${PRETEND} ln -sv "${EMACS_D}/share" "${DATA_DIR}/emacs"

# Install MacOS 'emacsclient' wrapper
if [[ "${SYSTEM}" == "Darwin" ]]; then
    APP_DIR="${HOME}/Applications"
    DST_APP="${APP_DIR}/EmacsClient.app"
    SRC_APP="${EMACS_D}/share/apple/EmacsClient.app"
    [[ -h "${DST_APP}" ]] && ${PRETEND} rm -f "${DST_APP}"
    ${PRETEND} mkdir -p "${APP_DIR}" && ${PRETEND} ln -sv "${SRC_APP}" "${DST_APP}"
fi

# Set environment vars
cat << EOF > "${HOME}/.profile.d/editor.sh"
# Set 'emacsclient' as default editor
EDITOR="emcl"
GIT_EDITOR="\${EDITOR} --no-fork"
SUDO_EDITOR="\${EDITOR} --no-fork"

export EDITOR GIT_EDITOR SUDO_EDITOR
EOF
